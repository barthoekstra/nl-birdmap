---
title: "Netherlands Bird Migration Map"
subtitle: "Based on weather radar measurements"
author: Bart Hoekstra
#output: html_notebook
---

```{r setup, message=FALSE, warning=TRUE, include=FALSE}
library(tidyverse)
library(bioRad)
library(suncalc)
library(terra)
library(tidyterra)
library(raster)
library(sf)
library(stars)
library(parallel)
library(ggdark)
library(ggblend)
library(spatialEco)
library(fields)
library(ggnewscale)
library(colorspace)
library(ggspatial)
library(ggpattern)
library(ggfx)
library(gghalves)
library(pbmcapply)
options(ggpattern_use_R4.1_masks = TRUE)
```

# Select peak nights
We start with loading a dataset containing cumulative passage metrics for day and night across Dutch weather radars, both seasons and all years.

```{r}
vp_mtr <- read_csv("data/vp_mtr_ordered_seasonal_day_night_migration.csv",
  col_types = cols(
    date_trunc = col_datetime(), odim_code = col_character(), year_season = col_character(), year = col_double(),
    season = col_character(), day_night = col_character(), slope_max = col_double(), slope_max_time = col_datetime(),
    mtr = col_double(), prop = col_double(), mtr_cum = col_double(), prop_cum = col_double(), top = col_double()
  )
) %>% 
  filter(day_night == "night")

head(vp_mtr %>% dplyr::select(date_trunc, odim_code, year, season, prop_cum, top), 10)
```
The dataset is sorted from largest night to smalles night in terms of cumulative passage, so we can select the peak nights that capture 50% of migration by selecting all nights that cumulatively have selected less and then the first night that pushes it above 50%.

```{r}
vp_mtr_cum50 <- vp_mtr %>%
  filter(prop_cum < 0.5 | (lag(prop_cum) < 0.5 & prop_cum >= 0.5))

vp_mtr_cum50
```

Now that we have identified the nights, we can calculate the moment of sunset, to find the polar volume scan closest to 2.5hrs after sunset.

```{r}
calculate_scantime <- function(r) {
  if (r["odim_code"] == "nlhrw") {
    lat <- 51.8371
    lon <- 5.138
  }
  if (r["odim_code"] == "nldhl") {
    lat <- 52.9528
    lon <- 4.79061
  }

  if (r["day_night"] == "daylight") {
    scantime <- suncalc::getSunlightTimes(lat = lat, lon = lon, date = as.Date(r["date_trunc"]), keep = "sunrise")
    scantime <- scantime$sunrise + hours(2)
  }
  if (r["day_night"] == "night") {
    scantime <- suncalc::getSunlightTimes(lat = lat, lon = lon, date = as.Date(r["date_trunc"]) - 1, keep = "sunset")
    scantime <- scantime$sunset + hours(2) + minutes(30)
  }

  scantime <- round_date(scantime, "5 mins")
}

scantimes <- as_datetime(unlist(apply(vp_mtr_cum50, MARGIN = 1, FUN = calculate_scantime, simplify = FALSE)))

vp_mtr_cum50$moment <- scantimes
vp_mtr_cum50
```
# Download peak time scans
From the `moment` column in the `vp_mtr_cum50` dataframe, one can distill which pvol files have to be downloaded from the KNMI weather radar repository. At the UvA, we host those publicly available datasets locally on a private [minio](https://min.io) S3 server, but others can download the polar volume files from the KNMI directly: [Herwijnen](https://dataplatform.knmi.nl/dataset/radar-tar-vol-full-herwijnen-1-0) and [Den Helder](https://dataplatform.knmi.nl/dataset/radar-tar-volume-denhelder-1-0) after [registering](https://developer.dataplatform.knmi.nl) for a free API key.

```{r eval=FALSE, include=FALSE}
# minio/pvol/NL/HRW/2016/08/31/NLHRW_pvol_20160831T2350_6356.h5
dts <- dplyr::select(vp_mtr_cum50, odim_code, moment)

dts_hrw <- dts %>%
  filter(odim_code == "nlhrw") %>%
  pull(moment)

filepaths_hrw <- paste0(
  "minio/pvol/NL/HRW/", year(dts_hrw), "/", sprintf("%02d", month(dts_hrw)), "/", sprintf("%02d", day(dts_hrw)), "/",
  "NLHRW_pvol_", format(dts_hrw, format = "%Y%m%dT%H%M"), "_6356.h5"
)
filepaths_hrw_alt <- paste0(
  "minio/pvol/NL/HRW/", year(dts_hrw), "/", sprintf("%02d", month(dts_hrw)), "/", sprintf("%02d", day(dts_hrw)), "/",
  "NLHRW_pvol_", format(dts_hrw, format = "%Y%m%dT%H%M"), "_NL52.h5"
)
paths <- list(paste0("mc cp ", filepaths_hrw, " ."), paste0("mc cp ", filepaths_hrw_alt, " ."))

write_lines(unlist(paths), file = "data/pvol/hrw_files.sh", )

dts_dhl <- dts %>%
  filter(odim_code == "nldhl") %>%
  pull(moment)

filepaths_dhl <- paste0(
  "minio/pvol/NL/DHL/", year(dts_dhl), "/", sprintf("%02d", month(dts_dhl)), "/", sprintf("%02d", day(dts_dhl)), "/",
  "NLDHL_pvol_", format(dts_dhl, format = "%Y%m%dT%H%M"), "_6234.h5"
)
filepaths_dhl_alt <- paste0(
  "minio/pvol/NL/DHL/", year(dts_dhl), "/", sprintf("%02d", month(dts_dhl)), "/", sprintf("%02d", day(dts_dhl)), "/",
  "NLDHL_pvol_", format(dts_dhl, format = "%Y%m%dT%H%M"), "_NL51.h5"
)
paths <- list(paste0("mc cp ", filepaths_dhl, " ."), paste0("mc cp ", filepaths_dhl_alt, " ."))

write_lines(unlist(paths), file = "data/pvol/dhl_files.sh", )
```

```{r eval=FALSE, include=FALSE}
downloaded_files <- list.files("data/pvol", full.names = TRUE)
downloaded_files <- downloaded_files[!downloaded_files %in% c("data/pvol/dhl_files.sh", "data/pvol/hrw_files.sh")]
downloaded_files_hrw <- downloaded_files[str_detect(downloaded_files, "NLHRW")]
downloaded_files_dhl <- downloaded_files[str_detect(downloaded_files, "NLDHL")]

downloaded_files_dhl_dts <- as_datetime(unlist(
  lapply(downloaded_files_dhl, function(x) parse_date_time(str_split(x, "_")[[1]][3], "YmdHM"))
))
downloaded_files_hrw_dts <- as_datetime(unlist(
  lapply(downloaded_files_hrw, function(x) parse_date_time(str_split(x, "_")[[1]][3], "YmdHM"))
))

downloaded_dts_dhl <- data.frame(pvolfile = downloaded_files_dhl, moment = downloaded_files_dhl_dts)
downloaded_dts_dhl$odim_code <- "nldhl"
downloaded_dts_hrw <- data.frame(pvolfile = downloaded_files_hrw, moment = downloaded_files_hrw_dts)
downloaded_dts_hrw$odim_code <- "nlhrw"
downloaded_dts <- bind_rows(downloaded_dts_dhl, downloaded_dts_hrw)

vp_mtr_cum50 %>%
  left_join(downloaded_dts, by = join_by(odim_code == odim_code, moment == moment)) %>%
  drop_na() -> vp_mtr_cum50
```

# Process RBCs
The pipeline used to convert the polar volume scans to range-bias corrected PPIs that we can incorporate in our bird migration maps, is self-contained in the `rbc_preprocessing.R` file.

# RBC selection
After processing the RBCs, there is a folder `data/rbc_png/full` that contains .png's with several diagnostic plots of the processed RBCs. These have to be manually screened for clutter from rain and anomalous propagation and files should be moved to the subfolders `Accepted` if the scans are clean examples of bird migration and `Rejected` if they aren't.

# Selected usable scans
We now add the outcome of the screening procedure to the dataframe containing an overview of our data.

```{r}
accepted_files <- list.files("data/rbc_png/full/Accepted/")
rejected_files <- list.files("data/rbc_png/full/Rejected/")

rbc_file_from_png <- function(file, azim_method = "full") {
  f <- basename(file)
  ss <- str_split(f, "_")[[1]][1:4]
  radar <- str_to_lower(ss[1])
  moment <- parse_date_time(ss[3], "YmdHM")
  fp <- paste0("data/rbc/", str_c(ss, collapse = "_"), "_", azim_method, ".RDS")
  return(list("odim_code" = radar, "moment" = moment, "rbcfile" = fp))
}

accepted <- bind_rows(lapply(accepted_files, rbc_file_from_png)) %>% mutate(status = "Accepted")
rejected <- bind_rows(lapply(rejected_files, rbc_file_from_png)) %>% mutate(status = "Rejected")

classified_moments <- bind_rows(accepted, rejected)

vp_mtr_cum50 %>%
  left_join(classified_moments, by = join_by(odim_code, moment)) %>%
  mutate(status = replace_na(status, "Rejected")) %>%
  drop_na() %>%
  identity() -> vp_mtr_cum50_cl
```

# Seasonal proportion of migration covered

Having screened the scans now, we can see what proportion of seasonal migration is captured in the clean scans.

```{r message=FALSE}
vp_mtr_cum50_cl %>%
  filter(status == "Accepted") %>%
  group_by(year, season, odim_code, day_night) %>%
  summarise(total_prop = sum(prop)) %>%
  mutate(
    season_date = case_when(
      season == "spring" ~ as.Date(paste(year, "03-15", sep = "-")),
      season == "autumn" ~ as.Date(paste(year, "09-15", sep = "-")),
      TRUE ~ NA_Date_
    ),
    radar_nice = case_when(
      odim_code == "nlhrw" ~ "Herwijnen",
      odim_code == "nldhl" ~ "Den Helder"
    ),
    day_night = case_when(
      day_night == "daylight" ~ "day",
      day_night == "night" ~ "night",
    ),
    day_night_nice = case_when(
      day_night == "day" ~ "Day",
      day_night == "night" ~ "Night"
    )
  ) %>%
  ungroup() %>%
  identity() -> sp

sp %>%
  group_by(odim_code, radar_nice) %>%
  summarise(
    mean_prop = mean(total_prop),
    min_prop = min(total_prop),
    max_prop = max(total_prop)
  ) %>%
  ungroup() -> sp_summary

sp_summary

sp %>%
  group_by(season) %>%
  summarise(
    mean_prop = mean(total_prop),
    min_prop = min(total_prop),
    max_prop = max(total_prop)
  ) %>%
  ungroup() -> sp_summary_seasonal

sp_summary_seasonal
```

```{r}
# Define the moon and sun symbols using Unicode
sp %>%
  mutate(total_prop = total_prop * 100) %>%
  ggplot() +
  geom_point(aes(x = season_date, y = total_prop, color = total_prop)) +
  geom_hline(data = sp_summary, aes(yintercept = mean_prop * 100), linetype = "dashed", color = "black") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  facet_wrap(vars(radar_nice)) +
  xlab("Season") +
  ylab("% of migration mapped") +
  labs(title = "Seasonal proportion of migration included in map", color = "% of migration")

ggsave("data/plots/seasonal_props.pdf", width = 10, height = 6)
```

# Process scans to season-year stacks
With all RBCs processed and all clean migration moments gathered, we can create stacks of season-year combinations (e.g. autumn 2017, autumn 2018, spring 2019, spring 2021). We store all the individual RBCs' VIR parameters as individual layers and average them to a layer called `VIR` (and some transformations like `VIR_sqrt` and `VIR_log10`. While creating the stacks, we filter out areas where the RBC matches the following conditions:

1. `VIR` is above `2500`
2. `VIR` is exactly `0` (the pixel has never reflected)
3. There is rain in one of the elevation scans above the pixel
4. The adjustment factor `R` is above `10`.

```{r}
stack_rbcs <- function(rbcs, year_season, odimcode, daytime = "night", threshold_max = 2500, mean_method = "scans", 
                       R_threshold = NULL, overwrite = FALSE, clutter_map = FALSE) {
  # See if files exist already
  if (is.null(R_threshold)) {
    R_text <- "null"
  } else {
    R_text <- R_threshold
  }

  basepath <- "data/stacks/"
  if (clutter_map) {
    basepath <- "data/stacks_clutter/"
  }
  
  filepath <- paste0(
    basepath,
    str_to_upper(odimcode), "_", year_season, "_thresh_", threshold_max, "_avg_", mean_method, "_", daytime, "_", R_text, ".RDS"
  )
  rasterpath <- paste0(
    basepath,
    str_to_upper(odimcode), "_", year_season, "_thresh_", threshold_max, "_avg_", mean_method, "_", daytime, "_", R_text, ".tif"
  )

  if (file.exists(filepath) && file.exists(rasterpath)) {
    if (!overwrite) {
      return("exists")
    }
  }

  r <- rbcs[[1]]
  rp <- r

  VIRs <- list()

  for (i in seq_along(rbcs)) {
    VIR <- rbcs[[i]]$data@data$VIR
    R <- rbcs[[i]]$data@data$R
    RAIN <- rbcs[[i]]$data@data$rain
    VIR[which(VIR > threshold_max)] <- NA
    VIR[which(VIR == 0)] <- NA
    VIR[which(RAIN > 0)] <- NA
    if (!is.null(R_threshold)) {
      VIR[which(R_threshold > 10)] <- NA
    }
    VIRs <- append(VIRs, list(VIR))
  }

  mVIR <- do.call(rbind, VIRs)
  mVIR[is.na(mVIR)] <- 0
  VIR_summed <- mVIR[1, ] * 0

  for (j in seq_along(VIRs)) {
    if (j == 1) {
      VIR_summed <- as.vector(as.matrix(mVIR[1:j, ]))
      rp$data@data[paste0("VIR_", j)] <- VIR_summed
      next
    }

    VIR_summed <- colSums(as.matrix(mVIR[1:j, ])) / j
    rp$data@data[paste0("VIR_", j)] <- as.numeric(VIR_summed)
  }

  remove_variables <- c("VID", "R", "overlap", "eta_sum", "eta_sum_expected", "rain")
  for (var in remove_variables) {
    rp$data@data[var] <- NULL
  }
  rp$data$VIR <- as.vector(as.matrix(rp$data@data[paste0("VIR_", length(VIRs))]))

  rp <- calculate_param(rp, VIR_log10 = log10(VIR), VIR_log = log(VIR), VIR_sqrt = sqrt(VIR))
  saveRDS(rp, filepath)
  rrast <- terra::rast(rp$data)
  fixedlayers <- c("VIR", "VIR_log10", "VIR_log", "VIR_sqrt")
  layernames <- names(rrast)
  layerorder <- c(which(layernames %in% fixedlayers), which(!layernames %in% fixedlayers))
  rrast <- subset(rrast, layerorder)
  rf <- terra::writeRaster(rrast, rasterpath, overwrite = overwrite)
  return(filepath)
}

g <- expand.grid(
  year_season = unique(vp_mtr_cum50_cl$year_season),
  day_night = unique(vp_mtr_cum50_cl$day_night),
  odim_code = unique(vp_mtr_cum50_cl$odim_code)
)

generate_stacks <- function(year_season, day_night, odim_code,
                            # th = c(500, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000),
                            th = 2500,
                            R_threshold = 10,
                            overwrite = FALSE) {
  vp_mtr_cum50_cl %>%
    filter(status == "Accepted", year_season == !!year_season, day_night == !!day_night, odim_code == !!odim_code) %>%
    drop_na() %>%
    arrange(top) %>%
    dplyr::select(rbcfile, prop) -> files

  if (nrow(files) == 0) {
    return("files do not exist")
  }

  gr <- expand.grid(th = th, R_threshold = R_threshold, stringsAsFactors = FALSE)
  gr <- asplit(gr, 1)

  rbcs <- lapply(files$rbcfile, readRDS)
  lapply(gr, function(x) {
    stack_rbcs(
      rbcs = rbcs, year_season = year_season, odimcode = odim_code,
      threshold_max = as.numeric(x["th"]), R_threshold = as.numeric(x["R_threshold"]), overwrite = overwrite
    )
  })
}

processing_stacking <- pbmcmapply(generate_stacks,
  year_season = g$year_season, day_night = g$day_night, odim_code = g$odim_code,
  overwrite = TRUE, mc.cores = 6, mc.preschedule = FALSE
)
saveRDS(processing_stacking, paste0("data/logs/processing_stacking_", format(Sys.time(), "%Y%m%dT%H%M"), ".RDS"))
```

# Combine season stacks to radar, period stacks
Now we can continue simply creating averages of the season-year stacks, resulting in rasters of average `VIR` per season per radar. We also limit the domain of the stacks to 100km from the radar now.

```{r}
final_stacks <- expand.grid(
  odim_code = c("NLHRW", "NLDHL"),
  season = c("spring", "autumn"),
  daytime = c("night"),
  th = 2500,
  mm = c("scans"),
  R_threshold = 10
)

for (i in 1:nrow(final_stacks)) {
  fs <- final_stacks[i, ]

  rastfiles <- Sys.glob(
    paste0("data/stacks/", str_to_upper(fs$odim_code), "_*_", fs$season, "_thresh_", fs$th, "_avg_", fs$mm, "_", fs$daytime, "_", fs$R_threshold, ".tif")
  )

  stk <- terra::rast(lapply(rastfiles, function(x) {
    tryCatch(terra::rast(x, lyrs = "VIR"),
      error = function(err) {
        print(err)
      }
    )
  }))
  rmean <- app(stk, mean)
  names(rmean) <- "vir_mean"

  file_out <- paste0(
    "data/final_stacks/", fs$daytime, "/", fs$mm, "/",
    fs$odim_code, "_", fs$season, "_thresh_", fs$th, "_avg_", fs$mm, "_", fs$daytime, "_", fs$R_threshold, ".tif"
  )
  if (!dir.exists(dirname(file_out))) dir.create(dirname(file_out), recursive = TRUE)

  if (fs$odim_code == "NLHRW") {
    lat <- 51.8371
    lon <- 5.138
  }
  if (fs$odim_code == "NLDHL") {
    lat <- 52.9528
    lon <- 4.79061
  }

  circle_radius <- 100000 # 100 km in meters

  # Create a simple features (sf) point object
  center_point <- st_sfc(st_point(c(lon, lat)))

  # Buffer the point to create a circular polygon
  st_crs(center_point) <- 4326
  center_point <- st_transform(center_point, crs = st_crs(rmean))
  circle <- st_buffer(center_point, dist = circle_radius)
  masked_raster <- st_rasterize(st_as_sf(circle), st_as_stars(st_bbox(rmean, values = NA_real_), nx = 640, ny = 640))
  masked_raster[masked_raster == 0] <- NA

  raster_masked <- terra::mask(rmean, as(masked_raster, "SpatRaster"))

  writeRaster(raster_masked, file_out, overwrite = TRUE)
}
```

# Combine radar, time stacks to national-level maps

We can now combine the radar-level seasonal averages to national-level maps per season. In the overlap zone between both radars, we use max-compositing as this provides the smoothest transition in average `VIR` values between the radars.

```{r}
final_stacks <- expand.grid(
  season = c("spring", "autumn"),
  daytime = c("night"),
  th = c(2500),
  mm = c("scans"),
  zmax = c(750),
  R_threshold = 10
)

fstacks <- asplit(final_stacks, 1)

save_map <- function(x, overwrite = FALSE, mode = "dark") {
  fs <- x

  fstacks <- paste0(
    "data/final_stacks/", fs["daytime"], "/", fs["mm"], "/", c("NLHRW", "NLDHL"), "_",
    fs["season"], "_thresh_", fs["th"], "_avg_", fs["mm"], "_", fs["daytime"], "_", fs["R_threshold"], ".tif"
  )
  fstacks <- str_replace_all(fstacks, " ", "")
  mapfile <- paste0(
    "data/maps/", fs["daytime"], "/", fs["mm"],
    "/NL_", fs["season"], "_", fs["daytime"], "_thresh_", fs["th"], "_avg_", fs["mm"], "_", fs["R_threshold"], ".tif"
  )
  mapfile <- str_replace_all(mapfile, " ", "")

  if (file.exists(mapfile) & !overwrite) {
    return(mapfile)
  }

  if (!dir.exists(dirname(mapfile))) dir.create(dirname(mapfile), recursive = TRUE)

  mapfile_plot <- paste0(
    "data/maps_plots/VIR_", fs["zmax"], "/", fs["daytime"], "/", fs["mm"], "/NL_",
    fs["season"], "_", fs["daytime"], "_thresh_", fs["th"], "_avg_", fs["mm"], "_", fs["R_threshold"], ".png"
  )
  mapfile_plot <- str_replace_all(mapfile_plot, " ", "")
  if (!dir.exists(dirname(mapfile_plot))) dir.create(dirname(mapfile_plot), recursive = TRUE)

  r1 <- rast(fstacks[1]) %>% project("EPSG:28992")
  r2 <- rast(fstacks[2]) %>% project("EPSG:28992")

  bbox1 <- ext(r1)
  bbox2 <- ext(r2)

  combined_bbox <- c(min(bbox1$xmin, bbox2$xmin), max(bbox1$xmax, bbox2$xmax), min(bbox1$ymin, bbox2$ymin), max(bbox1$ymax, bbox2$ymax))

  rn <- rast(ext = combined_bbox, crs = "EPSG:28992")
  res(rn) <- 500

  r1_resampled <- resample(r1, rn)
  r2_resampled <- resample(r2, rn)

  m <- mosaic(sprc(r1_resampled, r2_resampled), fun = max)
  writeRaster(m, mapfile, overwrite = TRUE)

  data <- raster::as.data.frame(m, xy = TRUE)

  c <- crs(m)
  nl <- geojsonsf::geojson_sfc("data/gis/Netherlands.geojson") %>% st_transform(c)
  nhol <- geojsonsf::geojson_sfc("data/gis/Noord-Holland.geojson") %>% st_transform(c)
  nhol_buf <- geojsonsf::geojson_sfc("data/gis/Noord-Holland-10km-Buffer.geojson") %>% st_transform(c)
  radar_buf <- geojsonsf::geojson_sf("data/gis/Radars-100km-Buffer.geojson") %>% st_transform(c)

  radar_bbox <- st_bbox(radar_buf)

  padding <- 500
  xlim <- c(radar_bbox$xmin - padding, radar_bbox$xmax + padding)
  ylim <- c(radar_bbox$ymin - padding, radar_bbox$ymax + padding)
  zlim <- c(0, as.numeric(fs["zmax"]))
  tod <- if_else(fs["daytime"] == "night", "by Night", "by Day")
  title <- paste0(str_to_sentence(fs["season"]), " ", tod)

  if (mode == "dark") {
    ggplot(data) +
      geom_raster(aes(x = x, y = y, fill = vir_mean / 11)) +
      scale_fill_viridis_c(limits = zlim / 11, name = "Mean\nVID", oob = scales::squish, option = "inferno") +
      geom_sf(data = nl, fill = "NA", color = "white", linewidth = .3) +
      geom_sf(data = radar_buf, fill = "NA", color = "#ffffffaa", linewidth = .3) +
      coord_sf(xlim = xlim, ylim = ylim, expand = FALSE) +
      ggtitle(title) +
      dark_theme_minimal() +
      theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 10),
        axis.text = element_text(color = alpha("white", 0.25)),
        panel.grid.major = element_line(color = alpha("white", 0.1)),
        panel.grid.minor = element_line(color = "white"),
        plot.title.position = "plot",
        legend.position = c(1.02, 0.66),
        plot.margin = unit(c(1, 1, 1, 1), "cm")
      ) -> pl1
  } else if (mode == "light") {
    ggplot(data) +
      geom_raster(aes(x = x, y = y, fill = vir_mean / 11)) +
      scale_fill_viridis_c(limits = zlim / 11, name = "Mean\nVID", oob = scales::squish, option = "inferno") +
      geom_sf(data = nl, fill = "NA", color = "black", linewidth = .3) +
      geom_sf(data = radar_buf, fill = "NA", color = "#000000aa", linewidth = .3) +
      coord_sf(xlim = xlim, ylim = ylim, expand = FALSE) +
      ggtitle(title) +
      theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 10),
        axis.text = element_text(color = alpha("black", 0.25)),
        panel.grid.major = element_line(color = alpha("black", 0.1)),
        panel.grid.minor = element_line(color = "black"),
        plot.title.position = "plot",
        legend.position = c(1.02, 0.66),
        legend.background = element_rect(fill = "#00000000"),
        plot.margin = unit(c(1, 1, 1, 1), "cm")
      ) -> pl1
  }

  ggsave(mapfile_plot, plot = pl1, width = 5, height = 6)
}

processing <- mclapply(fstacks, save_map, overwrite = TRUE, mode = "light", mc.cores = 10, mc.preschedule = FALSE)

saveRDS(processing, paste0("data/logs/processing_mapping_", format(Sys.time(), "%Y%m%dT%H%M"), ".RDS"))
```

# Clutter map creation
Now for the clutter map creation, we follow exactly the same approach up to now, but rather than looking at the migration peaks, we select the scans which supposedly have the least migration.

We start with selecting the lowest 25 scans in terms of nightly migration for each season.

```{r}
vp_mtr %>%
  group_by(year_season, odim_code, day_night) %>%
  filter(top >= tail(top, 25)[1]) %>% 
  identity() -> vp_mtr_low

scantimes <- as_datetime(unlist(apply(vp_mtr_low, MARGIN = 1, FUN = calculate_scantime, simplify = FALSE)))

vp_mtr_low$moment <- scantimes
vp_mtr_low
```
We download the corresponding polar volume files.

```{r}
dts <- dplyr::select(vp_mtr_low, odim_code, moment)

dts_hrw <- dts %>%
  filter(odim_code == "nlhrw") %>%
  pull(moment)

filepaths_hrw <- paste0(
  "minio/pvol/NL/HRW/", year(dts_hrw), "/", sprintf("%02d", month(dts_hrw)), "/", sprintf("%02d", day(dts_hrw)), "/",
  "NLHRW_pvol_", format(dts_hrw, format = "%Y%m%dT%H%M"), "_6356.h5"
)
filepaths_hrw_alt <- paste0(
  "minio/pvol/NL/HRW/", year(dts_hrw), "/", sprintf("%02d", month(dts_hrw)), "/", sprintf("%02d", day(dts_hrw)), "/",
  "NLHRW_pvol_", format(dts_hrw, format = "%Y%m%dT%H%M"), "_NL52.h5"
)
paths <- list(paste0("mc cp ", filepaths_hrw, " ."), paste0("mc cp ", filepaths_hrw_alt, " ."))

write_lines(unlist(paths), file = "data/pvol_clutter/hrw_files.sh", )

dts_dhl <- dts %>%
  filter(odim_code == "nldhl") %>%
  pull(moment)

filepaths_dhl <- paste0(
  "minio/pvol/NL/DHL/", year(dts_dhl), "/", sprintf("%02d", month(dts_dhl)), "/", sprintf("%02d", day(dts_dhl)), "/",
  "NLDHL_pvol_", format(dts_dhl, format = "%Y%m%dT%H%M"), "_6234.h5"
)
filepaths_dhl_alt <- paste0(
  "minio/pvol/NL/DHL/", year(dts_dhl), "/", sprintf("%02d", month(dts_dhl)), "/", sprintf("%02d", day(dts_dhl)), "/",
  "NLDHL_pvol_", format(dts_dhl, format = "%Y%m%dT%H%M"), "_NL51.h5"
)
paths <- list(paste0("mc cp ", filepaths_dhl, " ."), paste0("mc cp ", filepaths_dhl_alt, " ."))

write_lines(unlist(paths), file = "data/pvol_clutter/dhl_files.sh", )
```

And we process the files following the procedure in `rbc_preprocessing.R`. Afterwards, we screen scans again to remove cases with rain, anomalous propagation. We save information on the screening outcomes, to gather files to continue working with.

```{r}
accepted_files <- list.files("data/rbc_png_clutter/full/Accepted/")
rejected_files <- list.files("data/rbc_png_clutter/full/Rejected/")

rbc_file_from_png <- function(file, azim_method = "full") {
  f <- basename(file)
  ss <- str_split(f, "_")[[1]][1:4]
  radar <- str_to_lower(ss[1])
  moment <- parse_date_time(ss[3], "YmdHM")
  fp <- paste0("data/rbc_clutter/", str_c(ss, collapse = "_"), "_", azim_method, ".RDS")
  return(list("odim_code" = radar, "moment" = moment, "rbcfile" = fp))
}

accepted <- bind_rows(lapply(accepted_files, rbc_file_from_png)) %>% mutate(status = "Accepted")
rejected <- bind_rows(lapply(rejected_files, rbc_file_from_png)) %>% mutate(status = "Rejected")

classified_moments <- bind_rows(accepted, rejected)

vp_mtr_low %>%
  left_join(classified_moments, by = join_by(odim_code, moment)) %>%
  mutate(status = replace_na(status, "Rejected")) %>%
  identity() -> vp_mtr_low_cl
```

And again we can make the season-year stacks.

```{r}
g <- expand.grid(year_season = unique(vp_mtr_low_cl$year_season),
                 day_night = unique(vp_mtr_low_cl$day_night),
                 odim_code = unique(vp_mtr_low_cl$odim_code))

generate_stacks <- function(year_season, day_night, odim_code,
                            th = 2500,
                            R_threshold = 10,
                            overwrite = FALSE) {
  
  vp_mtr_low_cl %>%
    filter(status == "Accepted", year_season == !!year_season, day_night == !!day_night, odim_code == !!odim_code) %>%
    drop_na() %>%
    arrange(top) %>%
    dplyr::select(rbcfile, prop) -> files
  
  if (nrow(files) == 0) return("files do not exist")
  
  gr <- expand.grid(th = th, R_threshold = R_threshold, stringsAsFactors = FALSE)
  gr <- asplit(gr, 1)
  
  rbcs <- lapply(files$rbcfile, readRDS)
  lapply(gr, function(x) {stack_rbcs(rbcs = rbcs, year_season = year_season, odimcode = odim_code, 
                                     threshold_max = as.numeric(x["th"]), R_threshold = x["R_threshold"], overwrite = overwrite, clutter_map = TRUE)})
}

processing_stacking <- pbmcmapply(generate_stacks, year_season = g$year_season, day_night = g$day_night, 
                                odim_code = g$odim_code, overwrite = TRUE, mc.cores = 6, mc.preschedule = TRUE)
saveRDS(processing_stacking, paste0("data/logs/processing_stacking_clutter_", format(Sys.time(), "%Y%m%dT%H%M"), ".RDS"))
```

Which now we'll aggregate to to seasonal averages.

```{r}
final_stacks <- expand.grid(
  odim_code = c("NLHRW", "NLDHL"),
  season = c("spring", "autumn"),
  daytime = c("night"),
  th = 2500,
  mm = c("scans"),
  R_threshold = 10
)

for (i in 1:nrow(final_stacks)) {
  fs <- final_stacks[i, ]
  
  rastfiles <- Sys.glob(
    paste0("data/stacks_clutter/", str_to_upper(fs$odim_code), "_*_", fs$season, "_thresh_", fs$th, "_avg_", 
           fs$mm, "_", fs$daytime, "_", fs$R_threshold, ".tif")
  )
  
  stk <- terra::rast(lapply(rastfiles, function(x) {
    tryCatch(terra::rast(x, lyrs = "VIR"), 
             error = function(err) {
               print(err)
             })
  }))
  
  rmean <- app(stk, mean) 
  names(rmean) <- "vir_mean"
  
  file_out <- paste0("data/final_stacks_clutter/", fs$daytime, "/", fs$mm, "/", 
                     fs$odim_code, "_", fs$season, "_thresh_", fs$th, "_avg_", fs$mm, "_", fs$daytime, "_", fs$R_threshold, ".tif")
  if (!dir.exists(dirname(file_out))) dir.create(dirname(file_out), recursive = TRUE)
  
  if (fs$odim_code == "NLHRW") {
    lat <- 51.8371
    lon <- 5.138
  }
  if (fs$odim_code == "NLDHL") {
    lat <- 52.9528
    lon <- 4.79061
  }
  
  circle_radius <- 100000  # 100 km in meters

  # Create a simple features (sf) point object
  center_point <- st_sfc(st_point(c(lon, lat)))
  
  # Buffer the point to create a circular polygon
  st_crs(center_point) <- 4326
  center_point <- st_transform(center_point, crs = st_crs(rmean))
  circle <- st_buffer(center_point, dist = circle_radius)
  masked_raster <- st_rasterize(st_as_sf(circle), st_as_stars(st_bbox(rmean, values = NA_real_), nx = 640, ny = 640))
  masked_raster[masked_raster == 0] <- NA
  
  raster_masked <- terra::mask(rmean, as(masked_raster, "SpatRaster"))
  
  writeRaster(raster_masked, file_out, overwrite = TRUE)
}
```

```{r}
final_stacks <- expand.grid(season = c("spring", "autumn"),
                            daytime = c("day", "night"),
                            th = c(2500),
                            mm = c("scans",),
                            zmax = c(2000))

fstacks <- asplit(final_stacks, 1)
  
save_map <- function(x, overwrite = FALSE) {
  fs <- x
  
  fstacks <- paste0("data/final_stacks_clutter/", fs["daytime"], "/", fs["mm"], "/", c("NLHRW", "NLDHL"), "_", 
                    fs["season"], "_thresh_", fs["th"], "_avg_", fs["mm"], "_", fs["daytime"], ".tif")
  fstacks <- str_replace_all(fstacks, " ", "")
  mapfile <- paste0("data/maps_clutter/", fs["daytime"], "/", fs["mm"], 
                    "/NL_", fs["season"], "_", fs["daytime"], "_thresh_", fs["th"], "_avg_", fs["mm"], ".tif")
  mapfile <- str_replace_all(mapfile, " ", "")
  
  if(file.exists(mapfile) & !overwrite) return(mapfile)
  
  if (!dir.exists(dirname(mapfile))) dir.create(dirname(mapfile), recursive = TRUE)
  
  mapfile_plot <- paste0("data/maps_plots_borderless_transparent_clutter/VIR_", fs["zmax"], "/", fs["daytime"], "/", fs["mm"], "/NL_", fs["season"], "_", fs["daytime"], "_thresh_", fs["th"], "_avg_", fs["mm"], ".png")
  # mapfile_plot <- paste0("data/maps_plots_borderless_transparent_temp/VIR_", fs["zmax"], "/", fs["daytime"], "/", fsmm, "/NL_", 
  #                        fs["season"], "_", fs["daytime"], "_thresh_", fs["th"], "_avg_", fsmm, "_", fs["sp"], ".pdf")
  mapfile_plot <- str_replace_all(mapfile_plot, " ", "")
  if (!dir.exists(dirname(mapfile_plot))) dir.create(dirname(mapfile_plot), recursive = TRUE)
  
  r1 <- rast(fstacks[1]) %>% project("EPSG:28992")
  r2 <- rast(fstacks[2]) %>% project("EPSG:28992")
  
  bbox1 <- ext(r1)
  bbox2 <- ext(r2)
  
  combined_bbox <- c(min(bbox1$xmin, bbox2$xmin), max(bbox1$xmax, bbox2$xmax), 
                     min(bbox1$ymin, bbox2$ymin), max(bbox1$ymax, bbox2$ymax))
  
  rn <- rast(ext = combined_bbox, crs = "EPSG:28992")
  res(rn) <- 500
  
  r1_resampled <- resample(r1, rn)
  r2_resampled <- resample(r2, rn)
  
  m <- mosaic(sprc(r1_resampled, r2_resampled), fun = mean)
  writeRaster(m, mapfile, overwrite = TRUE)
  
  data <- raster::as.data.frame(m, xy = TRUE)
  
  c <- crs(m)
  nl <- geojsonsf::geojson_sfc("data/gis/Netherlands.geojson") %>% st_transform(c)
  nhol <- geojsonsf::geojson_sfc("data/gis/Noord-Holland.geojson") %>% st_transform(c)
  nhol_buf <- geojsonsf::geojson_sfc("data/gis/Noord-Holland-10km-Buffer.geojson") %>% st_transform(c)
  radar_buf <- geojsonsf::geojson_sf("data/gis/Radars-100km-Buffer.geojson") %>% st_transform(c)
  
  radar_bbox <- st_bbox(radar_buf)
  
  padding <- 500
  # xlim <- c(min(data$x), max(data$x))
  xlim <- c(radar_bbox$xmin - padding, radar_bbox$xmax + padding)
  # ylim <- c(min(data$y), max(data$y))
  ylim <- c(radar_bbox$ymin - padding, radar_bbox$ymax + padding)
  zlim <- c(0, quantile(data$mean, 0.95))
  zlim <- c(0, as.numeric(fs["zmax"]))
  season <- if_else(fs["daytime"] == "night", "by Night", "by Day")
  title <- paste0(str_to_sentence(fs["season"]), " ", season)
  subtitle <- paste0("Noise threshold: ", fs["th"], " / Stacking method: ", fsmm)
  
  ggplot(data) +
    geom_raster(aes(x = x, y = y, fill = vir_mean / 11)) +
    scale_fill_viridis_c(limits = zlim / 11, name = "Mean\nVIR", oob = scales::squish, option = "inferno") +
    geom_sf(data = nl, fill = "NA", color = "white", linewidth = .3) +
    #geom_sf(data = nhol_buf, fill = "NA", color = "white", linewidth = .3) +
    #geom_sf(data = nhol, fill = "NA", color = "white", linewidth = .3) +
    geom_sf(data = radar_buf, fill = "NA", color = "#ffffffaa", linewidth = .3) +
    # geom_sf(data = radar_buf, fill = "NA", color = alpha("#ffffff", 0.5), linewidth = .3) +
    coord_sf(xlim = xlim, ylim = ylim, expand = FALSE) +
    # ggtitle(title, subtitle) +
    ggtitle(title) +
    dark_theme_minimal() +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          plot.title = element_text(size = 14),
          plot.subtitle = element_text(size = 10),
          # axis.text.x = element_text(color = "white"),
          # axis.text.y = element_text(color = "white"),
          axis.text = element_text(color = alpha("white", 0.25)),
          panel.grid.major = element_line(color = alpha("white", 0.1)),
          panel.grid.minor = element_line(color = "white"),
          plot.title.position = "plot",
          #plot.background = element_rect(color = "black", fill = "black", linewidth = 6),
          # plot.background = element_rect(color = "NA", fill = "NA"),
          legend.position = c(1.02, 0.66),
          plot.margin = unit(c(1,1,1,1), "cm")) -> pl1
  
  ggsave(mapfile_plot, plot = pl1, width = 5, height = 6)
}

# processing <- mclapply(fstacks, save_map, overwrite = TRUE, mc.cores = 10, mc.preschedule = FALSE)
processing <- lapply(fstacks, save_map, overwrite = TRUE)

saveRDS(processing, paste0("data/logs/processing_mapping_", format(Sys.time(), "%Y%m%dT%H%M"), ".RDS"))
```

# Clutter removal

```{r}
clutter_maps <- expand.grid(season = c("spring", "autumn"),
                            daytime = c("day", "night"),
                            thresh = c(100, 150, 200, 250, 300),
                            s = c(1, 2, 3, 4, 5, 6, 7),
                            n = c(13, 17, 21, 25, 29),
                            stringsAsFactors = FALSE)

create_final_map_set <- function(map_grid, buffer_patches = NULL,
                                 custom_clutter = NULL) {
  cm <- asplit(map_grid, 1)

  for (m in cm) {
    r <- rast(paste0("data/maps/", m["daytime"], "/scans/NL_", m["season"], "_", m["daytime"],
                     "_thresh_2500_avg_scans_seasons_nonstandardized.tif"))
    if (is.null(custom_clutter)) {
      rc <- rast(paste0("data/maps_clutter/", m["daytime"], "/scans/NL_", m["season"], "_", m["daytime"],
                        "_thresh_2500_avg_scans.tif"))
      # Create denoised clutter map
      rc[rc < t] <- NA
      rc[rc >= t] <- 1
    } else {
      if (is.logical(custom_clutter)) {
        rc <- rast(paste0("data/final_maps/custom_clutter/NL_", m["season"], "_", m["daytime"], ".tif"))
      } else if (is.character(custom_clutter)) {
        rc <- rast(custom_clutter)
      }
    }
    
    t <- as.numeric(m["thresh"])
    s <- as.numeric(m["s"])
    n <- as.numeric(m["n"])
    
    # Prepare GIS data for plots
    c <- crs(r)
    nl <- geojsonsf::geojson_sfc("data/gis/Netherlands.geojson") %>% st_transform(c)
    nhol <- geojsonsf::geojson_sfc("data/gis/Noord-Holland.geojson") %>% st_transform(c)
    nhol_buf <- geojsonsf::geojson_sfc("data/gis/Noord-Holland-10km-Buffer.geojson") %>% st_transform(c)
    radar_buf <- geojsonsf::geojson_sf("data/gis/Radars-100km-Buffer.geojson") %>% st_transform(c)
    
    prc <- patches(rc)
    zrc <- zonal(cellSize(prc, unit = "km"), prc, sum, as.raster = TRUE)
    src <- ifel(zrc < 2, NA, prc)
    rcn <- rc
    rcn[is.na(src)] <-NA
    
    if (!is.null(buffer_patches)) {
      rcn <- buffer(rcn, width = buffer_patches)
      rcn <- rcn * 1
      rcn[rcn == 0] <- NA
    }
    
    cluts <- c(rc, rcn)
    cls <- as.data.frame(cluts, xy = TRUE)
    colnames(cls) <- c("x", "y", "clut_orig", "clut_denoised")
    cls %>% pivot_longer(cols = -c(x, y), names_to = "clut_type") %>% drop_na() -> cls
    ggplot() +
      geom_raster(aes(x = x, y = y, fill = clut_type, group = clut_type), data = cls) +
      facet_wrap(~clut_type) +
      dark_theme_minimal() +
      geom_sf(data = nl, fill = "NA", color = "white", linewidth = .3) +
      geom_sf(data = nhol, fill = "NA", color = "white", linewidth = .3) +
      geom_sf(data = radar_buf, fill = "NA", color = "white", linewidth = .3) +
      theme(axis.title.x = element_blank(),
            axis.title.y = element_blank(),
            plot.title = element_text(size = 14),
            plot.subtitle = element_text(size = 10),
            axis.text = element_text(color = alpha("white", 0.25)),
            panel.grid.major = element_line(color = alpha("white", 0.1)),
            panel.grid.minor = element_line(color = "white"),
            plot.title.position = "plot",
            plot.margin = unit(c(1,1,1,1), "cm")) -> pclut
    
    # Save plot
    fp_clutplot <- paste0("data/final_maps/plots/NL_", m["season"], "_", m["daytime"], 
                          "_thresh_", t, "_s_", s, "_n_", n, "_clut.png")
    ggsave(pclut, width = 7, height = 4, filename = fp_clutplot)
    
    # Save clutter map
    fp_clut <- paste0("data/final_maps/NL_", m["season"], "_", m["daytime"], 
                      "_thresh_", t, "_s_", s, "_n_", n, "_clutter.tif")
    writeRaster(rcn, fp_clut, overwrite = TRUE)
    
    # Create final bird map
    rn <- r
    rn[rcn == 1] <- NA
    
    # Blur
    suppressMessages({
      b <- raster.gaussian.smooth(rn, s=s, n=n, na.rm = TRUE, type = "mean")
    })
    
    # Remove area introduced by blur
    b[is.na(r)] <- NA
    
    # Save bird map
    fp_bird <- paste0("data/final_maps/NL_", m["season"], "_", m["daytime"], 
                      "_thresh_", t, "_s_", s, "_n_", n, ".tif")
    writeRaster(b, fp_bird, overwrite = TRUE)
    
    # Plots for quick overviews
    if (m["season"] == "autumn") {
      zlims <- c(0, 800)
    } else if (m["season"] == "spring") {
      zlims <- c(0, 400)
    }
    
    data <- as.data.frame(b, xy = TRUE)
    clut <- as.data.frame(rcn, xy = TRUE)
    
    ggplot() +
      geom_raster(aes(x = x, y = y, fill = focal_mean), data = data) +
      scale_fill_viridis_c(limits = zlims, oob = scales::squish, option = "inferno", na.value = 0, name = "Mean VIR") +
      new_scale_fill() +
      geom_raster(data = clut, aes(x = x, y = y), fill = alpha("black", 0.4)) +
      geom_sf(data = nl, fill = "NA", color = "white", linewidth = .3) +
      geom_sf(data = nhol, fill = "NA", color = "white", linewidth = .3) +
      geom_sf(data = radar_buf, fill = "NA", color = "white", linewidth = .3) +
      dark_theme_minimal() +
      labs(title = paste0(str_to_sentence(m["season"]), " by ", m["daytime"])) +
      theme(axis.title.x = element_blank(),
            axis.title.y = element_blank(),
            plot.title = element_text(size = 14),
            plot.subtitle = element_text(size = 10),
            # axis.text.x = element_text(color = "white"),
            # axis.text.y = element_text(color = "white"),
            axis.text = element_text(color = alpha("white", 0.25)),
            panel.grid.major = element_line(color = alpha("white", 0.1)),
            panel.grid.minor = element_line(color = "white"),
            plot.title.position = "plot",
            plot.margin = unit(c(1,1,1,1), "cm"))-> p
    
    # Save plot
    fp_plot <- paste0("data/final_maps/plots/NL_", m["season"], "_", m["daytime"], 
                      "_thresh_", t, "_s_", s, "_n_", n, ".png")
    ggsave(p, filename = fp_plot)
    
    # Log
    print(m)
  }
}

create_final_map_set(clutter_maps)

# mclapply(clutter_maps, create_final_map_set, mc.cores = 14, mc.preschedule = TRUE)
```

After a visual inspection of the plots above, we have settled on using clutter maps with a VIR threshold of 250

```{r}
# final_clutter_maps <- list.files("data/final_maps", pattern = "*thresh_250_s_4_n_21_clutter.tif", full.names = TRUE)

clutter_maps <- expand.grid(season = c("spring", "autumn"),
                            daytime = c("day", "night"),
                            thresh = c(250),
                            s = c(4),
                            n = c(25),
                            stringsAsFactors = FALSE)

clutter_maps_files <- list.files("data/final_maps/custom_clutter", full.names = TRUE)

cl <- rast(clutter_maps_files)
cl <- app(cl, sum, na.rm = TRUE)
cl[cl > 1] <- 1
writeRaster(cl, "data/final_maps/custom_clutter/NL_combined.tif", overwrite = TRUE)

# create_final_map_set(clutter_maps, buffer_patches = 500, 
#                      custom_clutter = "data/final_maps/custom_clutter/NL_combined.tif")
# mclapply(clutter_maps, create_final_map_set, buffer_patches = 250, custom_clutter = TRUE, 
         # mc.cores = 4, mc.preschedule = TRUE)
create_final_map_set(clutter_maps, buffer_patches = NULL, custom_clutter = "data/final_maps/custom_clutter/NL_combined.tif")
```

# Beam blockage

After calculating beam blockage using "beam-blockage/beamblockage.ipynb", two .csv's storing x,y,z and CBB (cumulative beam blockage) values are created for both HRW and DHL radars. We will turn these in raster files which can be used in this project.

```{r}
hrw_bb <- read_csv("data/beam_blockage/hrw.csv", col_types = "dddddd") %>% 
  dplyr::select(x, y, CBB)

dhl_bb <- read_csv("data/beam_blockage/dhl.csv", col_types = "dddddd") %>%
  dplyr::select(x, y, CBB)

exrast_hrw <- rast("data/final_stacks/night/scans/NLHRW_autumn_thresh_2500_avg_scans_night_seasons_nonstandardized.tif")
exrast_dhl <- rast("data/final_stacks/night/scans/NLDHL_autumn_thresh_2500_avg_scans_night_seasons_nonstandardized.tif")

v_hrw <- vect(hrw_bb, geom = c("x", "y"), crs = "epsg:4326") %>% project(exrast_hrw)
v_dhl <- vect(dhl_bb, geom = c("x", "y"), crs = "epsg:4326") %>% project(exrast_dhl)

cbb_hrw <- rasterize(v_hrw, exrast_hrw, field = "CBB", fun = max) %>%
  focal(w = c(5, 5), fun = "max", na.rm = TRUE)
cbb_dhl <- rasterize(v_dhl, exrast_dhl, field = "CBB", fun = max) %>%
  focal(w = c(5, 5), fun = "max", na.rm = TRUE)
writeRaster(cbb_hrw, "data/beam_blockage/hrw.tif", overwrite = TRUE)
writeRaster(cbb_dhl, "data/beam_blockage/dhl.tif", overwrite = TRUE)

plot(cbb_hrw)
plot(cbb_dhl)

clip_to_radius <- function(raster_full, odim_code, radius) {
  if (odim_code == "NLHRW") {
    lat <- 51.8371
    lon <- 5.138
  }
  if (odim_code == "NLDHL") {
    lat <- 52.9528
    lon <- 4.79061
  }
  
  circle_radius <- radius  # 100 km in meters

  # Create a simple features (sf) point object
  center_point <- st_sfc(st_point(c(lon, lat)))
  
  # Buffer the point to create a circular polygon
  st_crs(center_point) <- 4326
  center_point <- st_transform(center_point, crs = st_crs(raster_full))
  circle <- st_buffer(center_point, dist = circle_radius)
  # mask(x = raster_data, mask = circle)  
  masked_raster <- st_rasterize(st_as_sf(circle), st_as_stars(st_bbox(raster_full, values = NA_real_), nx = 640, ny = 640))
  masked_raster[masked_raster == 0] <- NA
  
  raster_masked <- terra::mask(raster_full, as(masked_raster, "SpatRaster"))
  raster_masked
}

r1 <- cbb_hrw %>% clip_to_radius("NLHRW", 100000) %>% project("EPSG:28992")
r2 <- cbb_dhl %>% clip_to_radius("NLDHL", 100000) %>% project("EPSG:28992")

# r1[r1 == 0] <- NA
# r2[r2 == 0] <- NA

bbox1 <- ext(r1)
bbox2 <- ext(r2)

combined_bbox <- c(min(bbox1$xmin, bbox2$xmin), max(bbox1$xmax, bbox2$xmax), 
                   min(bbox1$ymin, bbox2$ymin), max(bbox1$ymax, bbox2$ymax))

rn <- rast(ext = combined_bbox, crs = "EPSG:28992")
res(rn) <- 500

r1_resampled <- resample(r1, rn)
r2_resampled <- resample(r2, rn)

m <- mosaic(sprc(r1_resampled, r2_resampled), fun = "last") # DHL should be last!
m[m == 0] <- NA
plot(m)
writeRaster(m, "data/beam_blockage/NL_beamblockage.tif", overwrite = TRUE)
```


# Final maps

```{r}
ban <- rast("data/final_maps/NL_autumn_night_thresh_250_s_4_n_25.tif")
bsn <- rast("data/final_maps/NL_spring_night_thresh_250_s_4_n_25.tif")
bad <- rast("data/final_maps/NL_autumn_day_thresh_250_s_4_n_25.tif")
bsd <- rast("data/final_maps/NL_spring_day_thresh_250_s_4_n_25.tif")

da <- ban - bsn
db <- bad - bsd

scale01 <- function(r) {
  nx <- minmax(r)    
  rn <- (r - nx[1,]) / (nx[2,] - nx[1,])
  rn
}

ban_s <- scale01(ban)
bsn_s <- scale01(bsn)
bad_s <- scale01(bad)
bsd_s <- scale01(bsd)

da_s <- ban_s - bsn_s
db_s <- bad_s - bsd_s
# rcn <- rast("data/final_maps/NL_autumn_night_thresh_250_s_4_n_25_clutter.tif")
# cbb <- rast("data/beam_blockage/NL_beamblockage.tif")

c <- st_crs(ban)
nl <- geojsonsf::geojson_sf("data/gis/Netherlands.geojson") %>% st_transform(c)
nl_buf <- geojsonsf::geojson_sfc("data/gis/Netherlands-5km-Buffer.geojson") %>% st_transform(c)
clut_buf <- geojsonsf::geojson_sf("data/gis/NL_Clutter-500m-Buffer.geojson") %>% st_transform(c) %>% st_as_sf()
bb <- geojsonsf::geojson_sfc("data/gis/NL_Beamblockage.geojson") %>% st_transform(c) %>% st_as_sf()
bb$pattern <- "stripe"
nhol <- geojsonsf::geojson_sfc("data/gis/Noord-Holland.geojson") %>% st_transform(c)
nhol_buf <- geojsonsf::geojson_sfc("data/gis/Noord-Holland-10km-Buffer.geojson") %>% st_transform(c)
nhol_bbox <- st_bbox(nhol_buf)
radar_buf <- geojsonsf::geojson_sf("data/gis/Radars-100km-Buffer.geojson") %>% st_transform(c)
radars <- geojsonsf::geojson_sf("data/gis/Radars.geojson") %>% st_transform(c) %>% filter(acronym != "artis")

egmondaanzee <- st_read("data/gis/all_gemeentes/wijk_2020_v3.shp") %>% st_transform(c) %>% filter(WK_CODE == "WK037304") %>% 
  st_buffer(100) %>% st_union() %>% st_as_sf() %>% mutate(gebied = "Egmond aan Zee") %>% rename(geometry = x)

gebieden <- geojsonsf::geojson_sf("data/gis/gemeenten.geojson") %>% st_transform(c) %>% 
  filter(Gemeentenaam %in% c("Amsterdam", "Diemen")) %>%
  rename(gebied = Gemeentenaam) %>%
  dplyr::select(gebied, geometry) %>%
  bind_rows(nhol %>% st_as_sf() %>% rename(geometry = x) %>% mutate(gebied = "Noord-Holland")) %>%
  bind_rows(nl %>% mutate(gebied = "Nederland") %>% dplyr::select(gebied, geometry)) %>%
  bind_rows(egmondaanzee)

bbc <- st_geometry(bb) %>% st_intersection(st_geometry(nl_buf))
clut_bufc <- st_geometry(clut_buf) %>% st_intersection(st_geometry(nl_buf))
uncertainty <- spatialEco::sf_dissolve(st_as_sf(st_union(bbc, clut_bufc)))
uncertainty$certainty <- "Onzeker"

res_all <- st_read("data/gis/RES/RES_zoekgebieden_Actueel.shp") %>% 
  filter(str_detect(`Type_`, 'Wind') | str_detect(`Type_`, 'wind')) %>% 
  st_transform(c)
res_all %>%
  sf:::select.sf(RES_id, Naam_gebie, Type_, Regio, RES_deel_r) %>%
  st_difference(clut_bufc) %>%
  mutate(Naam_gebie = str_replace(Naam_gebie, "\\d+[a-z]\\) ", ""),
         ID = row_number()) %>%
  identity() -> res

ban_extract <- extract(ban, vect(res), raw = TRUE) %>% as.data.frame() %>% rename(VIR_autumn = focal_mean)
bsn_extract <- extract(bsn, vect(res), raw = TRUE) %>% as.data.frame() %>% rename(VIR_spring = focal_mean)

ban_extract %>%
  cbind(bsn_extract %>% dplyr::select(VIR_spring)) %>%
  left_join(res, by = "ID") %>%
  arrange(desc(VIR_autumn)) %>%
  mutate(VID_autumn = VIR_autumn / 11,
         VID_spring = VIR_spring / 11,
         Naam_gebie = as.factor(Naam_gebie),
         Naam_gebie = fct_reorder(Naam_gebie, VIR_autumn),
         geometry_x = st_coordinates(st_centroid(geometry))[,1],
         geometry_y = st_coordinates(st_centroid(geometry))[,2]) %>%
  group_by(Naam_gebie) %>%
  mutate(VID_mean = mean(VID_autumn)) %>%
  ungroup() %>%
  group_by(RES_deel_r) %>%
  mutate(mean_x = mean(geometry_x),
         mean_y = mean(geometry_y),
         RES_deel_r = as.factor(RES_deel_r),
         RES_deel_r = fct_reorder(RES_deel_r, mean_y, .desc = FALSE),
         RES_deel_r = recode(RES_deel_r,
                             "Regio Alkmaar" = "Alkmaar",
                             "West-Friesland" = "West-Friesland",
                             "IJmond-Zuid Kennemerland" = "IJmond/\nZuid-Kennemerland",
                             "Zaanstreek-Waterland" = "Zaanstreek/\nWaterland",
                             "Amsterdam" = "Amsterdam",
                             "Amstelland" = "Amstelland",
                             "Haarlemmermeer" = "Haarlemmermeer")) %>%
  ungroup() %>%
  identity() -> res_summaries

res_summaries %>%
  ggplot(aes(x = VID_autumn, y = Naam_gebie)) +
  ggdist::stat_pointinterval(aes(color = VID_mean), .width = c(1, .5)) +
  scale_color_viridis_c(begin = 0.1, name = "Vogels/km2", guide = guide_none()) +
  dark_theme_gray(base_size = 12, base_family = "Helvetica") +
  # facet_grid(vars(fct_reorder(RES_deel_r, mean_y, .desc = TRUE)), scales = "free_y", space = "free_y") +
  theme(strip.text.y.right = element_text(angle = 0),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.key.width = unit(0.7, "inches"),
        legend.key.height = unit(0.2, "inches")) +
  labs(title = "Dichtheid vogels per zoekgebied (nachttrek)", 
       x = expression("vogels / km"^2),
       y = "")

ggsave(filename = "data/final_maps_plots/zoekgebieden.pdf", width = 8, height = 7)

res_summaries %>%
  ggplot(aes(x = VID_autumn, y = Naam_gebie)) +
  stat_pointinterval(aes(color = VID_mean), .width = c(1, .5)) +
  scale_color_viridis_c(begin = 0.1, name = "Vogels/km2", guide = guide_none()) +
  dark_theme_gray(base_size = 12, base_family = "Helvetica") +
  facet_grid(vars(fct_reorder(RES_deel_r, mean_y, .desc = TRUE)), scales = "free_y", space = "free_y") +
  theme(strip.text.y.right = element_text(angle = 0),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.key.width = unit(0.7, "inches"),
        legend.key.height = unit(0.2, "inches")) +
  labs(title = "Dichtheid vogels per zoekgebied (nachttrek)", 
       x = expression("vogels / km"^2),
       y = "")

ggsave(filename = "data/final_maps_plots/zoekgebieden_per_deelgebied.pdf", width = 8, height = 7)

res_summaries %>%
  group_by(Naam_gebie) %>%
  summarise(autumn = mean(VID_autumn),
            spring = mean(VID_spring),
            mean_seasons = mean(c(autumn, spring))) %>%
  ungroup() %>%
  ggplot(aes(y = Naam_gebie, x = mean_seasons, group = Naam_gebie)) +
  geom_linerange(aes(y = Naam_gebie, xmin = spring, xmax = autumn), color = alpha("white", 0.5)) +
  geom_point(aes(y = Naam_gebie, x = spring, color = "Voorjaar")) +
  geom_point(aes(y = Naam_gebie, x = autumn, color = "Najaar")) +
  scale_color_manual(values = c("Voorjaar" = "blue", "Najaar" = "red"), name = "Seizoen") +
  dark_theme_gray() +
  theme(legend.direction = "horizontal",
        legend.position = c(1, 0),
        legend.justification = c("right", "bottom"),
        legend.key.width = unit(0.3, "inches"),
        legend.key.height = unit(0.2, "inches"),
        legend.background = element_rect(fill = NA),
        legend.key = element_rect(fill = NA)) +
  labs(title = "Gemiddelde dichtheid vogels per zoekgebied (nachttrek)", 
       x = expression("vogels / km"^2),
       y = "")

ggsave(filename = "data/final_maps_plots/verschil_voorjaar_najaar_per_zoekgebied.pdf", width = 8, height = 7)

avg_an <- st_as_sf(aggregate(st_as_stars(ban), by = res, FUN = mean, na.rm = TRUE)) %>% st_drop_geometry() %>%
  rename(VIR_autumn_night = 1) %>%
  mutate(VID_autumn_night = VIR_autumn_night / 11)
avg_sn <- st_as_sf(aggregate(st_as_stars(bsn), by = res, FUN = mean, na.rm = TRUE)) %>% st_drop_geometry() %>%
  rename(VIR_spring_night = 1) %>%
  mutate(VID_spring_night = VIR_spring_night / 11)
avg_ad <- st_as_sf(aggregate(st_as_stars(bad), by = res, FUN = mean, na.rm = TRUE)) %>% st_drop_geometry() %>%
  rename(VIR_autumn_day = 1) %>%
  mutate(VID_autumn_day = VIR_autumn_day / 11)
avg_sd <- st_as_sf(aggregate(st_as_stars(bsd), by = res, FUN = mean, na.rm = TRUE)) %>% st_drop_geometry() %>%
  rename(VIR_spring_day = 1) %>%
  mutate(VID_spring_day = VIR_spring_day / 11)

res_averages <- cbind(res, avg_an, avg_sn, avg_ad, avg_sd)
# res_averages_label <- res_averages %>%
#   slice(which(rank(VIR_autumn_night) %in% 1:3), which(rank(desc(VIR_autumn_night)) %in% 1:3)) %>%
n_display <- 5

res_averages_label <- res_averages %>%
  mutate(rank_top = rank(desc(VIR_autumn_night)),
         rank_bottom = rank(VIR_autumn_night),
         label = paste0(rank_top, ". ", Naam_gebie, "\n", round(VID_autumn_night), " vogels/km2"),
         rank_class = if_else(rank_top <= n_display, 1, 0)) %>%
  slice(which(rank_top %in% 1:n_display), which(rank_bottom %in% 1:n_display))

res_bbox <- st_bbox(res_averages)
res_bbox["xmin"] <- res_bbox["xmin"] - 15000

nl_buf_spatvector <- vect(nl_buf)

ban <- terra::mask(ban, nl_buf_spatvector)
bsn <- terra::mask(bsn, nl_buf_spatvector)
bad <- terra::mask(bad, nl_buf_spatvector)
bsd <- terra::mask(bsd, nl_buf_spatvector)

map_to_df <- function(map, s, d, z) {
  as.data.frame(map, xy = TRUE) %>%
    rename("vir_mean" = "focal_mean") %>%
    mutate(vid_mean = vir_mean / 11,
           season = s,
           daytime = d,
           zlim = z)
}

data <- mapply(map_to_df, map = list(ban, bsn, bad, bsd), 
               s = c("autumn", "spring", "autumn", "spring"), 
               d = c("night", "night", "day", "day"),
               z = c(800, 800, 350, 350),
               SIMPLIFY = FALSE) %>%
  bind_rows()
  
data %>%
  filter(daytime == "night") %>%
  ggplot() +
  geom_raster(aes(x = x, y = y, fill = vir_mean)) +
  scale_fill_viridis_c(limits = c(0, 750), oob = scales::squish, option = "inferno", na.value = 0,
                       name = "VIR (cm2/km2)") +
  new_scale_fill() +
  geom_raster(aes(x = x, y = y, fill = vid_mean)) +
  scale_fill_viridis_c(limits = c(0, 750/11), oob = scales::squish, option = "inferno", na.value = 0,
                       name = "VID (vogels/km2)") +
  # geom_raster(data = clut, aes(x = x, y = y), fill = alpha("black", 0.2)) +
  # geom_raster(data = cbb %>% filter(focal_max > 0.05), aes(x = x, y = y), fill = alpha("black", 0.2)) +
  geom_sf(data = nl_buf, fill = "NA", color = alpha("black", 0.9), linewidth = 1) +
  geom_sf(data = st_union(radar_buf), fill = "NA", color = alpha("black", 0.9), linewidth = 1) +
  geom_sf(data = nl, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  # geom_sf(data = nl_buf, fill = "NA", color = "white", linewidth = .3) +
  geom_sf(data = nhol, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = radar_buf, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf_pattern(aes(pattern = certainty),
                  data = uncertainty %>% st_intersection(nl_buf),
                  fill = alpha("black", 0.1), color = alpha("white", 0.1),
                  pattern_density = 0.3, pattern_spacing = 0.005, pattern_fill = alpha("white", 0.1), pattern_color = NA) +
  scale_pattern_manual(values = "stripe", name = "Onzekerheid") +
  annotation_scale(text_col = "white", style = "ticks", line_col = "white") +
  dark_theme_minimal() +
  facet_wrap(vars(season, daytime)) +
  # labs(title = paste0(str_to_sentence(m["season"]), " by ", m["daytime"])) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 10),
        # axis.text.x = element_text(color = "white"),
        # axis.text.y = element_text(color = "white"),
        axis.text = element_text(color = alpha("white", 0.25)),
        # plot.background = element_rect(fill = "NA", ),
        plot.background = element_rect(fill = "black", color = "NA"),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = alpha("white", 0.1)),
        panel.grid.minor = element_line(color = "white"),
        plot.title.position = "plot",
        plot.margin = unit(c(1,1,1,1), "cm"),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.key.width = unit(0.4, "inch"))

ggsave("data/final_maps_plots/night.pdf", width = 17, height = 10, device = cairo_pdf)

```

```{r}
nhol_bbox_expanded <- nhol_bbox
padding <- 50000
nhol_bbox_expanded["xmin"] <- nhol_bbox_expanded["xmin"] - padding
nhol_bbox_expanded["xmax"] <- nhol_bbox_expanded["xmax"] + padding
nhol_bbox_expanded["ymin"] <- nhol_bbox_expanded["ymin"] - padding
nhol_bbox_expanded["ymax"] <- nhol_bbox_expanded["ymax"] + padding

pol_bbox <- st_as_sf(st_as_sfc(st_bbox(nhol_bbox_expanded)))
pol_nhol <- nhol_buf

nhol_outside_mask <- st_difference(pol_bbox, pol_nhol)

data %>%
  filter(daytime == "night", season == "autumn") %>%
  ggplot() +
  # geom_raster(aes(x = x, y = y, fill = vir_mean)) +
  # scale_fill_viridis_c(limits = c(0, 750), oob = scales::squish, option = "inferno", na.value = 0, 
  #                      name = "VIR (cm2/km2)") +
  # new_scale_fill() +
  geom_raster(aes(x = x, y = y, fill = vid_mean)) +
  scale_fill_viridis_c(limits = c(0, 770/11), oob = scales::squish, option = "inferno", na.value = 0,
                       name = "VID (vogels/km2)", guide = guide_colorbar(nbin = 1000), breaks = seq(0, 770/11, by = 10)) +
  # geom_raster(data = clut, aes(x = x, y = y), fill = alpha("black", 0.2)) +
  # geom_raster(data = cbb %>% filter(focal_max > 0.05), aes(x = x, y = y), fill = alpha("black", 0.2)) +
  geom_sf(data = nl_buf, fill = "NA", color = alpha("black", 0.9), linewidth = 3) +
  geom_sf(data = st_union(radar_buf), fill = "NA", color = alpha("black", 0.9), linewidth = 1) +
  geom_sf(data = nl, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  # geom_sf(data = nl_buf, fill = "NA", color = "white", linewidth = .3) +
  geom_sf(data = nhol, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = radar_buf, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  # geom_label_repel(aes(label = label, geometry = geometry), fill = alpha("black", 0.2),
  #                  data = res_averages_label, stat = "sf_coordinates",
  #                  max.overlaps = 100, size = 1.5, min.segment.length = 0,
  #                  position = position_nudge_repel(y = -7500, x = 5000)) +
  geom_sf_pattern(aes(pattern = certainty),
                  data = uncertainty %>% st_intersection(nl_buf),
                  fill = alpha("black", 0.1), color = alpha("white", 0.1),
                  pattern_density = 0.3, pattern_spacing = 0.015, pattern_fill = alpha("white", 0.1), pattern_color = NA) +
  scale_pattern_manual(values = "stripe", name = "Onzekerheid") +
  geom_sf(data = res_averages, fill = alpha("black", 0.3), color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = res_averages_label, fill = alpha("black", 0.3), color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = nhol_outside_mask, fill = alpha("black", 0.6), color = NA) +
  annotation_scale(text_col = "white", style = "ticks", line_col = "white") +
  coord_sf(xlim = c(nhol_bbox_expanded["xmin"], nhol_bbox_expanded["xmax"]),
           ylim = c(nhol_bbox_expanded["ymin"], nhol_bbox_expanded["ymax"]),
           expand = FALSE) +
  dark_theme_minimal(base_family = "Helvetica") +
  # facet_wrap(vars(season, daytime)) +
  # labs(title = paste0(str_to_sentence(m["season"]), " by ", m["daytime"])) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 10),
        # axis.text.x = element_text(color = "white"),
        # axis.text.y = element_text(color = "white"),
        axis.text = element_text(color = alpha("white", 0.25)),
        # plot.background = element_rect(fill = "NA", ),
        plot.background = element_rect(fill = "black", color = "NA"),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = alpha("white", 0.1)),
        panel.grid.minor = element_line(color = "white"),
        plot.title.position = "plot",
        plot.margin = unit(c(1,1,1,1), "cm"),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.key.width = unit(0.4, "inch"))

ggsave("data/final_maps_plots/night_no_labels.pdf", width = 17, height = 10, device = cairo_pdf)
ggsave("data/final_maps_plots/night_no_labels.pdf", width = 16, height = 20, device = cairo_pdf)

radars <- geojsonsf::geojson_sf("data/gis/Radars.geojson") %>% st_transform(c)

data %>%
  filter(daytime == "night", season == "autumn") %>%
  ggplot() +
  geom_raster(aes(x = x, y = y, fill = vir_mean)) +
  # scale_fill_viridis_c(limits = c(0, 750), oob = scales::squish, option = "inferno", na.value = 0, 
  #                      name = "VIR (cm2/km2)") +
  # new_scale_fill() +
  geom_raster(aes(x = x, y = y, fill = vid_mean)) +
  scale_fill_viridis_c(limits = c(0, 750/11), oob = scales::squish, option = "inferno", na.value = 0,
                       name = "VID (vogels/km2)") +
  # geom_raster(data = clut, aes(x = x, y = y), fill = alpha("black", 0.2)) +
  # geom_raster(data = cbb %>% filter(focal_max > 0.05), aes(x = x, y = y), fill = alpha("black", 0.2)) +
  geom_sf(data = nl_buf, fill = "NA", color = alpha("black", 0.9), linewidth = 3) +
  geom_sf(data = st_union(radar_buf), fill = "NA", color = alpha("black", 0.9), linewidth = 2) +
  geom_sf(data = nl, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  # geom_sf(data = nl_buf, fill = "NA", color = "white", linewidth = .3) +
  geom_sf(data = nhol, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = radar_buf, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = radars, fill = "NA", color = alpha("white", 0.9), linewidth = 3, size = 3) +
  # geom_label_repel(aes(label = label, geometry = geometry), fill = alpha("black", 0.2),
  #                  data = res_averages_label, stat = "sf_coordinates",
  #                  max.overlaps = 100, size = 1.5, min.segment.length = 0,
  #                  position = position_nudge_repel(y = -7500, x = 5000)) +
  geom_sf_pattern(aes(pattern = certainty),
                  data = uncertainty %>% st_intersection(nl_buf),
                  fill = alpha("black", 0.1), color = alpha("white", 0.1),
                  pattern_density = 0.3, pattern_spacing = 0.01, pattern_fill = alpha("white", 0.1), pattern_color = NA) +
  scale_pattern_manual(values = "stripe", name = "Onzekerheid") +
  geom_sf(data = res_averages, fill = alpha("black", 0.3), color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = res_averages_label, fill = alpha("black", 0.3), color = alpha("white", 0.3), linewidth = .3) +
  annotation_scale(text_col = "white", style = "ticks", line_col = "white") +
  # coord_sf(xlim = c(nhol_bbox_expanded["xmin"], nhol_bbox_expanded["xmax"]), 
  #          ylim = c(nhol_bbox_expanded["ymin"], nhol_bbox_expanded["ymax"])) +
  # coord_sf(expand = TRUE)
  dark_theme_minimal(base_family = "Helvetica") +
  # facet_wrap(vars(season, daytime)) +
  # labs(title = paste0(str_to_sentence(m["season"]), " by ", m["daytime"])) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 10),
        # axis.text.x = element_text(color = "white"),
        # axis.text.y = element_text(color = "white"),
        axis.text = element_text(color = alpha("white", 0.25)),
        # plot.background = element_rect(fill = "NA", ),
        plot.background = element_rect(fill = "black", color = "NA"),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = alpha("white", 0.1)),
        panel.grid.minor = element_line(color = "white"),
        plot.title.position = "plot",
        plot.margin = unit(c(1,1,1,1), "cm"),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.key.width = unit(0.4, "inch"))

ggsave("data/final_maps_plots/night_no_labels_large.pdf", width = 16, height = 20, device = cairo_pdf)

data %>%
  filter(daytime == "night", season == "spring") %>%
  ggplot() +
  geom_raster(aes(x = x, y = y, fill = vir_mean)) +
  # scale_fill_viridis_c(limits = c(0, 750), oob = scales::squish, option = "inferno", na.value = 0, 
  #                      name = "VIR (cm2/km2)") +
  # new_scale_fill() +
  geom_raster(aes(x = x, y = y, fill = vid_mean)) +
  scale_fill_viridis_c(limits = c(0, 750/11), oob = scales::squish, option = "inferno", na.value = 0,
                       name = "VID (vogels/km2)") +
  # geom_raster(data = clut, aes(x = x, y = y), fill = alpha("black", 0.2)) +
  # geom_raster(data = cbb %>% filter(focal_max > 0.05), aes(x = x, y = y), fill = alpha("black", 0.2)) +
  geom_sf(data = nl_buf, fill = "NA", color = alpha("black", 0.9), linewidth = 3) +
  geom_sf(data = st_union(radar_buf), fill = "NA", color = alpha("black", 0.9), linewidth = 2) +
  geom_sf(data = nl, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  # geom_sf(data = nl_buf, fill = "NA", color = "white", linewidth = .3) +
  geom_sf(data = nhol, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = radar_buf, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = radars, fill = "NA", color = alpha("white", 0.9), linewidth = 3, size = 3) +
  # geom_label_repel(aes(label = label, geometry = geometry), fill = alpha("black", 0.2),
  #                  data = res_averages_label, stat = "sf_coordinates",
  #                  max.overlaps = 100, size = 1.5, min.segment.length = 0,
  #                  position = position_nudge_repel(y = -7500, x = 5000)) +
  geom_sf_pattern(aes(pattern = certainty),
                  data = uncertainty %>% st_intersection(nl_buf),
                  fill = alpha("black", 0.1), color = alpha("white", 0.1),
                  pattern_density = 0.3, pattern_spacing = 0.01, pattern_fill = alpha("white", 0.1), pattern_color = NA) +
  scale_pattern_manual(values = "stripe", name = "Onzekerheid") +
  geom_sf(data = res_averages, fill = alpha("black", 0.3), color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = res_averages_label, fill = alpha("black", 0.3), color = alpha("white", 0.3), linewidth = .3) +
  annotation_scale(text_col = "white", style = "ticks", line_col = "white") +
  # coord_sf(xlim = c(nhol_bbox_expanded["xmin"], nhol_bbox_expanded["xmax"]), 
  #          ylim = c(nhol_bbox_expanded["ymin"], nhol_bbox_expanded["ymax"])) +
  # coord_sf(expand = TRUE)
  dark_theme_minimal(base_family = "Helvetica") +
  # facet_wrap(vars(season, daytime)) +
  # labs(title = paste0(str_to_sentence(m["season"]), " by ", m["daytime"])) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 10),
        # axis.text.x = element_text(color = "white"),
        # axis.text.y = element_text(color = "white"),
        axis.text = element_text(color = alpha("white", 0.25)),
        # plot.background = element_rect(fill = "NA", ),
        plot.background = element_rect(fill = "black", color = "NA"),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = alpha("white", 0.1)),
        panel.grid.minor = element_line(color = "white"),
        plot.title.position = "plot",
        plot.margin = unit(c(1,1,1,1), "cm"),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.key.width = unit(0.4, "inch"))

ggsave("data/final_maps_plots/night_spring_no_labels_large.pdf", width = 16, height = 20, device = cairo_pdf)
```

```{r}
uncertainty_spatvector <- vect(uncertainty)

ban_uncertainty_filtered <- terra::mask(ban, uncertainty_spatvector, inverse = TRUE)
nl_avg <- aggregate(ban_uncertainty_filtered, fun = mean)

avg_gebieden <- st_as_sf(aggregate(st_as_stars(ban_uncertainty_filtered), by = gebieden, FUN = mean, na.rm = TRUE)) %>% st_drop_geometry() %>%
  rename(VIR_autumn_night = 1) %>%
  mutate(VID_autumn_night = VIR_autumn_night / 11)

gebieden %>%
  bind_cols(avg_gebieden) %>%
  rename(VID = VID_autumn_night,
         VIR = VIR_autumn_night) %>%
  mutate(gebied = recode(gebied, 
                         "Diemen" = "Gemeente Diemen",
                         "Amsterdam" = "Gemeente Amsterdam"),
         gebied = as.factor(gebied),
         gebied = fct_reorder(gebied, VID)) -> gebieden_summarised

ggplot() +
  geom_col(aes(y = gebied, x = VID), data = gebieden_summarised %>% filter(gebied != "Nederland"), fill = "yellow") +
  geom_vline(xintercept = gebieden_summarised$VID[gebieden_summarised$gebied == "Nederland"], linewidth = 1) +
  dark_theme_minimal(base_family = "Helvetica", base_size = 16) +
  labs(x = "vogels/km2", y = "")

ggsave("data/final_maps_plots/Gemeentes_Provincie.pdf", width = 10, height = 3.5)
```


data %>%
  filter(daytime == "day") %>%
  ggplot() +
  geom_raster(aes(x = x, y = y, fill = vir_mean)) +
  scale_fill_viridis_c(limits = c(0, 300), oob = scales::squish, option = "inferno", na.value = 0, 
                       name = "VIR (cm2/km2)") +
  new_scale_fill() +
  geom_raster(aes(x = x, y = y, fill = vid_mean)) +
  scale_fill_viridis_c(limits = c(0, 300/11), oob = scales::squish, option = "inferno", na.value = 0, 
                       name = "VID (vogels/km2)") +
  # geom_raster(data = clut, aes(x = x, y = y), fill = alpha("black", 0.2)) +
  # geom_raster(data = cbb %>% filter(focal_max > 0.05), aes(x = x, y = y), fill = alpha("black", 0.2)) +
  geom_sf(data = nl_buf, fill = "NA", color = alpha("black", 0.9), linewidth = 1) +
  geom_sf(data = st_union(radar_buf), fill = "NA", color = alpha("black", 0.9), linewidth = 1) +
  geom_sf(data = nl, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  # geom_sf(data = nl_buf, fill = "NA", color = "white", linewidth = .3) +
  geom_sf(data = nhol, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = radar_buf, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf_pattern(aes(pattern = certainty), 
                  data = uncertainty %>% st_intersection(nl_buf), 
                  fill = alpha("black", 0.1), color = alpha("white", 0.1),
                  pattern_density = 0.3, pattern_spacing = 0.005, pattern_fill = alpha("white", 0.1), pattern_color = NA) +
  scale_pattern_manual(values = "stripe", name = "Onzekerheid") +
  annotation_scale(text_col = "white", style = "ticks", line_col = "white") +
  dark_theme_minimal() +
  facet_wrap(vars(season, daytime)) +
  # labs(title = paste0(str_to_sentence(m["season"]), " by ", m["daytime"])) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 10),
        # axis.text.x = element_text(color = "white"),
        # axis.text.y = element_text(color = "white"),
        axis.text = element_text(color = alpha("white", 0.25)),
        # plot.background = element_rect(fill = "NA", ),
        plot.background = element_rect(fill = "black", color = "NA"),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = alpha("white", 0.1)),
        panel.grid.minor = element_line(color = "white"),
        plot.title.position = "plot",
        plot.margin = unit(c(1,1,1,1), "cm"),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.key.width = unit(0.4, "inch"))

ggsave("data/final_maps_plots/day.pdf", width = 17, height = 10, device = cairo_pdf)

# cmap_name <- "fusion"
# cmap_url <- paste0("https://raw.githubusercontent.com/1313e/CMasher/master/",
#                    "cmasher/colormaps/", cmap_name, "/", cmap_name, "_norm.txt")
# cmtable <- read.table(cmap_url)
# cmscale <- rgb(cmtable[,1], cmtable[,2], cmtable[,3])
# image(volcano, col=cmscale)

da %>%
  terra::mask(nl_buf_spatvector) %>%
  as.data.frame(xy = TRUE) %>%
  rename("vir_mean" = "focal_mean") %>%
  mutate(vid_mean = vir_mean / 11) %>%
  # filter(daytime == "day") %>%
  ggplot() +
  geom_raster(aes(x = x, y = y, fill = vir_mean)) +
  # scale_fill_continuous_diverging("Berlin", name = "VIR Difference") +
  # scico::scale_fill_scico(palette = "vik", midpoint = 0) +
  # scale_fill_gradient2(low = "red", high = "blue", mid = "white", midpoint = 0) +
  scale_fill_distiller(palette = "RdBu", type = "div", limits = c(-400, 400), oob = scales::squish, 
                       name = "VIR verschil (cm2/km2)") +
  # scale_fill_gradientn(colours = rev(cmscale), name = "VIR Difference", oob = scales::squish, limits = c(-300, 300)) +
  # new_scale_fill() +
  # geom_raster(data = clut, aes(x = x, y = y), fill = alpha("black", 0.2)) +
  # geom_raster(data = cbb %>% filter(focal_max > 0.05), aes(x = x, y = y), fill = alpha("black", 0.2)) +
  geom_sf(data = nl_buf, fill = "NA", color = alpha("black", 0.9), linewidth = 1) +
  geom_sf(data = st_union(radar_buf), fill = "NA", color = alpha("black", 0.9), linewidth = 1) +
  geom_sf(data = nl, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  # geom_sf(data = nl_buf, fill = "NA", color = "white", linewidth = .3) +
  geom_sf(data = nhol, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = radar_buf, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf_pattern(aes(pattern = certainty), 
                  data = uncertainty %>% st_intersection(nl_buf), 
                  fill = alpha("black", 0.1), color = alpha("white", 0.1),
                  pattern_density = 0.3, pattern_spacing = 0.005, pattern_fill = alpha("white", 0.1), pattern_color = NA) +
  scale_pattern_manual(values = "stripe", name = "Onzekerheid") +
  annotation_scale(text_col = "white", style = "ticks", line_col = "white") +
  dark_theme_minimal() +
  # facet_wrap(vars(season, daytime)) +
  # labs(title = paste0(str_to_sentence(m["season"]), " by ", m["daytime"])) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 10),
        # axis.text.x = element_text(color = "white"),
        # axis.text.y = element_text(color = "white"),
        axis.text = element_text(color = alpha("white", 0.25)),
        # plot.background = element_rect(fill = "NA", ),
        plot.background = element_rect(fill = "black", color = "NA"),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = alpha("white", 0.1)),
        panel.grid.minor = element_line(color = "white"),
        plot.title.position = "plot",
        plot.margin = unit(c(1,1,1,1), "cm"),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.key.width = unit(0.4, "inch"))

ggsave("data/final_maps_plots/diff_absolute_night.pdf", width = 10, height = 10, device = cairo_pdf)

da_s %>%
  terra::mask(nl_buf_spatvector) %>%
  as.data.frame(xy = TRUE) %>%
  rename("vir_mean" = "focal_mean") %>%
  mutate(vid_mean = vir_mean / 11) %>%
  # filter(daytime == "day") %>%
  ggplot() +
  geom_raster(aes(x = x, y = y, fill = vir_mean)) +
  scale_fill_distiller(palette = "RdBu", type = "div", limits = c(-0.5, 0.5), oob = scales::squish, 
                       name = "Rel. VIR verschil") +
  # scale_fill_continuous_diverging("Berlin", name = "VIR Difference") +
  # scale_fill_gradientn(colours = cmscale, name = "VIR Rel. Diff.", limits = c(-0.5, 0.5), oob = scales::squish) +
  geom_sf(data = nl_buf, fill = "NA", color = alpha("black", 0.9), linewidth = 1) +
  geom_sf(data = st_union(radar_buf), fill = "NA", color = alpha("black", 0.9), linewidth = 1) +
  geom_sf(data = nl, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  # geom_sf(data = nl_buf, fill = "NA", color = "white", linewidth = .3) +
  geom_sf(data = nhol, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = radar_buf, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf_pattern(aes(pattern = certainty), 
                  data = uncertainty %>% st_intersection(nl_buf),
                  fill = alpha("black", 0.1), color = alpha("white", 0.1),
                  pattern_density = 0.3, pattern_spacing = 0.005, pattern_fill = alpha("white", 0.1), pattern_color = NA) +
  scale_pattern_manual(values = "stripe", name = "Onzekerheid") +
  annotation_scale(text_col = "white", style = "ticks", line_col = "white") +
  dark_theme_minimal() +
  # facet_wrap(vars(season, daytime)) +
  # labs(title = paste0(str_to_sentence(m["season"]), " by ", m["daytime"])) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 10),
        # axis.text.x = element_text(color = "white"),
        # axis.text.y = element_text(color = "white"),
        axis.text = element_text(color = alpha("white", 0.25)),
        # plot.background = element_rect(fill = "NA", ),
        plot.background = element_rect(fill = "black", color = "NA"),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = alpha("white", 0.1)),
        panel.grid.minor = element_line(color = "white"),
        plot.title.position = "plot",
        plot.margin = unit(c(1,1,1,1), "cm"),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.key.width = unit(0.4, "inch"))

ggsave("data/final_maps_plots/diff_relative_night.pdf", width = 10, height = 10, device = cairo_pdf)

db %>%
  terra::mask(nl_buf_spatvector) %>%
  as.data.frame(xy = TRUE) %>%
  rename("vir_mean" = "focal_mean") %>%
  mutate(vid_mean = vir_mean / 11) %>%
  # filter(daytime == "day") %>%
  ggplot() +
  geom_raster(aes(x = x, y = y, fill = vir_mean)) +
  # scale_fill_continuous_diverging("Berlin", name = "VIR Difference") +
  # scico::scale_fill_scico(palette = "vik", midpoint = 0) +
  # scale_fill_gradient2(low = "red", high = "blue", mid = "white", midpoint = 0) +
  scale_fill_distiller(palette = "RdBu", type = "div", limits = c(-100, 100), oob = scales::squish, 
                       name = "VIR verschil (cm2/km2)") +
  # scale_fill_gradientn(colours = rev(cmscale), name = "VIR Difference", oob = scales::squish, limits = c(-300, 300)) +
  # new_scale_fill() +
  # geom_raster(data = clut, aes(x = x, y = y), fill = alpha("black", 0.2)) +
  # geom_raster(data = cbb %>% filter(focal_max > 0.05), aes(x = x, y = y), fill = alpha("black", 0.2)) +
  geom_sf(data = nl_buf, fill = "NA", color = alpha("black", 0.9), linewidth = 1) +
  geom_sf(data = st_union(radar_buf), fill = "NA", color = alpha("black", 0.9), linewidth = 1) +
  geom_sf(data = nl, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  # geom_sf(data = nl_buf, fill = "NA", color = "white", linewidth = .3) +
  geom_sf(data = nhol, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = radar_buf, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf_pattern(aes(pattern = certainty), 
                  data = uncertainty %>% st_intersection(nl_buf), 
                  fill = alpha("black", 0.1), color = alpha("white", 0.1),
                  pattern_density = 0.3, pattern_spacing = 0.005, pattern_fill = alpha("white", 0.1), pattern_color = NA) +
  scale_pattern_manual(values = "stripe", name = "Onzekerheid") +
  annotation_scale(text_col = "white", style = "ticks", line_col = "white") +
  dark_theme_minimal() +
  # facet_wrap(vars(season, daytime)) +
  # labs(title = paste0(str_to_sentence(m["season"]), " by ", m["daytime"])) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 10),
        # axis.text.x = element_text(color = "white"),
        # axis.text.y = element_text(color = "white"),
        axis.text = element_text(color = alpha("white", 0.25)),
        # plot.background = element_rect(fill = "NA", ),
        plot.background = element_rect(fill = "black", color = "NA"),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = alpha("white", 0.1)),
        panel.grid.minor = element_line(color = "white"),
        plot.title.position = "plot",
        plot.margin = unit(c(1,1,1,1), "cm"),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.key.width = unit(0.4, "inch"))

ggsave("data/final_maps_plots/diff_absolute_day.pdf", width = 10, height = 10, device = cairo_pdf)

db_s %>%
  terra::mask(nl_buf_spatvector) %>%
  as.data.frame(xy = TRUE) %>%
  rename("vir_mean" = "focal_mean") %>%
  mutate(vid_mean = vir_mean / 11) %>%
  # filter(daytime == "day") %>%
  ggplot() +
  geom_raster(aes(x = x, y = y, fill = vir_mean)) +
  scale_fill_distiller(palette = "RdBu", type = "div", limits = c(-0.5, 0.5), oob = scales::squish, 
                       name = "Rel. VIR verschil") +
  # scale_fill_continuous_diverging("Berlin", name = "VIR Difference") +
  # scale_fill_gradientn(colours = cmscale, name = "VIR Rel. Diff.", limits = c(-0.5, 0.5), oob = scales::squish) +
  geom_sf(data = nl_buf, fill = "NA", color = alpha("black", 0.9), linewidth = 1) +
  geom_sf(data = st_union(radar_buf), fill = "NA", color = alpha("black", 0.9), linewidth = 1) +
  geom_sf(data = nl, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  # geom_sf(data = nl_buf, fill = "NA", color = "white", linewidth = .3) +
  geom_sf(data = nhol, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = radar_buf, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf_pattern(aes(pattern = certainty), 
                  data = uncertainty %>% st_intersection(nl_buf),
                  fill = alpha("black", 0.1), color = alpha("white", 0.1),
                  pattern_density = 0.3, pattern_spacing = 0.005, pattern_fill = alpha("white", 0.1), pattern_color = NA) +
  scale_pattern_manual(values = "stripe", name = "Onzekerheid") +
  annotation_scale(text_col = "white", style = "ticks", line_col = "white") +
  dark_theme_minimal() +
  # facet_wrap(vars(season, daytime)) +
  # labs(title = paste0(str_to_sentence(m["season"]), " by ", m["daytime"])) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 10),
        # axis.text.x = element_text(color = "white"),
        # axis.text.y = element_text(color = "white"),
        axis.text = element_text(color = alpha("white", 0.25)),
        # plot.background = element_rect(fill = "NA", ),
        plot.background = element_rect(fill = "black", color = "NA"),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = alpha("white", 0.1)),
        panel.grid.minor = element_line(color = "white"),
        plot.title.position = "plot",
        plot.margin = unit(c(1,1,1,1), "cm"),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.key.width = unit(0.4, "inch"))

ggsave("data/final_maps_plots/diff_relative_day.pdf", width = 10, height = 10, device = cairo_pdf)

db_s %>%
  terra::mask(nl_buf_spatvector) %>%
  as.data.frame(xy = TRUE) %>%
  rename("vir_mean" = "focal_mean") %>%
  mutate(vid_mean = vir_mean / 11) %>%
  # filter(daytime == "day") %>%
  ggplot() +
  # geom_raster(aes(x = x, y = y, fill = vir_mean)) +
  # scale_fill_distiller(palette = "RdBu", type = "div", limits = c(-0.5, 0.5), oob = scales::squish, 
  #                      name = "Rel. VIR verschil") +
  # scale_fill_continuous_diverging("Berlin", name = "VIR Difference") +
  # scale_fill_gradientn(colours = cmscale, name = "VIR Rel. Diff.", limits = c(-0.5, 0.5), oob = scales::squish) +
  geom_sf(data = nl_buf, fill = "NA", color = alpha("black", 0.9), linewidth = 1) +
  geom_sf(data = st_union(radar_buf), fill = "NA", color = alpha("black", 0.9), linewidth = 1) +
  geom_sf(data = nl, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  # geom_sf(data = nl_buf, fill = "NA", color = "white", linewidth = .3) +
  geom_sf(data = nhol, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf(data = radar_buf, fill = "NA", color = alpha("white", 0.3), linewidth = .3) +
  geom_sf_pattern(aes(pattern = certainty), 
                  data = uncertainty %>% st_intersection(nl_buf),
                  fill = alpha("black", 0.2), color = alpha("white", 0.5),
                  pattern_density = 0.3, pattern_spacing = 0.005, pattern_fill = alpha("white", 0.2), pattern_color = NA) +
  scale_pattern_manual(values = "stripe", name = "Onzekerheid") +
  annotation_scale(text_col = "white", style = "ticks", line_col = "white") +
  dark_theme_minimal() +
  # facet_wrap(vars(season, daytime)) +
  # labs(title = paste0(str_to_sentence(m["season"]), " by ", m["daytime"])) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 10),
        # axis.text.x = element_text(color = "white"),
        # axis.text.y = element_text(color = "white"),
        axis.text = element_text(color = alpha("white", 0.25)),
        # plot.background = element_rect(fill = "NA", ),
        plot.background = element_rect(fill = "black", color = "NA"),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = alpha("white", 0.1)),
        panel.grid.minor = element_line(color = "white"),
        plot.title.position = "plot",
        plot.margin = unit(c(1,1,1,1), "cm"),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.key.width = unit(0.4, "inch"))

ggsave("data/final_maps_plots/uncertainty_areas.pdf", width = 10, height = 10, device = cairo_pdf)
```
